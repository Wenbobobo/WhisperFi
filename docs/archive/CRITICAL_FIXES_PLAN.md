# 核心修复计划 - 实现完整的匿名取款功能

## 1. 问题分析

经过深入分析，当前系统存在以下关键问题：

### 1.1 密码学不一致

- **存款阶段**: 使用 `Poseidon(secret, amount)` 生成承诺
- **取款阶段**: 使用 `Poseidon(secret, nullifier)` 生成承诺
- **解决方案**: 统一使用 `Poseidon(secret, nullifier)` 或根据电路定义调整

### 1.2 Merkle 树哈希函数不匹配

- **智能合约**: 使用 OpenZeppelin 的 `MerkleTree.Bytes32PushTree` (可能使用 Keccak256)
- **前端**: 使用 `fixed-merkle-tree` 库配合 Poseidon 哈希
- **解决方案**: 确保前端和合约使用相同的哈希函数

### 1.3 React 水合错误

- **问题**: 服务器端和客户端钱包连接状态不一致
- **解决方案**: 添加适当的 `useEffect` 和 `mounted` 状态管理

### 1.4 ZK 电路与实现不匹配

- **问题**: withdraw.circom 的输入输出与前端调用不匹配
- **解决方案**: 重新设计电路或调整前端调用

## 2. 修复方案

### 阶段 1: 统一密码学实现

1. 创建标准化的 commitment 生成函数
2. 确保存款和取款使用相同的 commitment 计算逻辑
3. 修复 Poseidon 哈希函数的同步/异步问题

### 阶段 2: 修复 React 水合问题

1. 添加客户端挂载状态管理
2. 使用 `useEffect` 处理钱包连接状态
3. 确保服务器端和客户端渲染一致

### 阶段 3: 重新设计 ZK 电路接口

1. 分析当前 withdraw.circom 的实际结构
2. 调整前端代码以匹配电路预期的输入格式
3. 确保公共输入和私有输入的正确传递

### 阶段 4: 实现完整的端到端测试

1. 创建一个测试序列：存款 → 生成证明 → 取款
2. 添加详细的调试日志
3. 验证每个步骤的正确性

## 3. 实现计划

### 3.1 立即执行的修复

- [ ] 修复 crypto.ts 中的 Promise 转换错误
- [ ] 统一 commitment 生成逻辑
- [ ] 修复 React 水合错误
- [ ] 添加调试日志

### 3.2 中期优化

- [ ] 重新实现 Merkle 树同步逻辑
- [ ] 优化 ZK 证明生成流程
- [ ] 添加错误处理和用户反馈

### 3.3 长期目标

- [ ] 实现完整的隐私交易流程
- [ ] 添加合规报告功能
- [ ] 优化用户体验

## 4. 成功标准

修复完成后，用户应该能够：

1. 成功存入 0.1 ETH
2. 使用相同的密钥生成有效的取款证明
3. 成功取出资金
4. 整个流程无控制台错误

## 5. 风险评估

### 高风险

- ZK 电路重新设计可能需要重新进行可信设置
- 密码学更改可能影响现有存款的兼容性

### 中风险

- 前端重构可能引入新的 bug
- 性能优化可能影响用户体验

### 低风险

- 调试日志和错误处理的添加
- UI 组件的改进
